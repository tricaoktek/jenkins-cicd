pipeline {
  agent any

  triggers {
    GenericTrigger(
     genericVariables: [
      [key: 'ref', value: '$.pull_request.base.ref']
     ],
     causeString: 'Triggered on $ref',
     token: 'project-name',
     printContributedVariables: true,
     printPostContent: true,
     silentResponse: false,
     regexpFilterText: '$ref',
     regexpFilterExpression: 'develop'
    )
  }

  stages {
    stage('Preparing source...') {
      steps {
        git branch: 'develop',
            credentialsId: 'tricao',
            url: 'git@github.com:tricaoktek/docker-demo.git'
      }
    }

    stage('Testing') {
      steps {
        script {
          try {
            telegramSend "üòÇ Testing..."
            nodejs(nodeJSInstallationName: 'nodejs') {
              sh 'npm install --only=dev'
              sh 'npm test'
            }
            telegramSend "üëçTesting Success ${ref}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'\n${env.BUILD_URL}"
          } catch(e) {
            // mark build as failed
            currentBuild.result = "FAILURE";

            // send slack notification
            telegramSend "üí© Something wrong: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL}).\nError: ${e}"

            // throw the error
            throw e;
          }
        }
      }
    }
  }
}